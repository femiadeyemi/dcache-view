<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/paper-styles/element-styles/paper-material-styles.html">

<link rel="import" href="user-image.html">
<link rel="import" href="../user-authentication/role-request/role-request.html">
<dom-module id="user-profile">
    <template>
        <style include="paper-material-styles">
            :host {
                display: flex;
                justify-content: center;
                min-width: 500px;
            }
            .paper-material {
                margin-top: 20px;
                width: 500px;
                background:#fff;
            }
            .paper-material + .paper-material {
                margin-top: 5px;
            }

            .paper-material .paper-material-inner {
                width: 100%;
                box-sizing: border-box;
            }

            .border-top {
                border-top: 5px solid #333;
            }

            .display-flex {
                display: flex;
            }
            .column {
                flex-direction: column;
            }
            .username-header {
                font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 48px;
                font-weight: 400;
                letter-spacing: -.012em;
                line-height: 48px;
            }
            .image-holder {
                width: 100px;
                justify-content: center;
            }
            .btn{
                background-color: #4285f4;
                color: white;
                --paper-button-raised-keyboard-focus: {
                    background-color: #4285f4 !important;
                    color: white !important;
                };
                border: none !important;
                text-transform: none;
                border-radius: 0 !important;
                margin: 0 !important;
                float: right;
            }
            .flex {
                flex: 1 1 auto;
            }
            .label {
                min-width: 150px;
                max-width: 150px;
                font-weight: bold;
            }
            .value {
                color: #757575;
                max-width: calc(452px - 150px + 68px);
                max-height: calc(70px - 24px);
                overflow-y: auto;
                word-wrap: break-word;
                margin-right: 10px;
            }
            .org {
                margin-top: 5px;
                margin-bottom: 5px;
                color: #ff625d;
                font-size: 0.8em;
            }
            .row {
                height: 70px;
                margin: 0 24px;
                padding: 24px 0;
                line-height: 1.4em;
                font-size: 12px;
                box-sizing: border-box;
            }
            .row + .row {
                border-top: 1px solid #eee;
            }
            .vertically-align {
                align-items: center;
            }
            .toggleBtn {
                --paper-toggle-button-checked-bar-color:  #0f9d58;
                --paper-toggle-button-checked-button-color:  #0f9d58;
                --paper-toggle-button-checked-ink-color: #0f9d58;
                --paper-toggle-button-unchecked-bar-color:  rgb(221, 44, 0);
                --paper-toggle-button-unchecked-button-color:  rgb(221, 44, 0);
                --paper-toggle-button-unchecked-ink-color: rgb(221, 44, 0);
            }
            .hide {
                display: none;
            }
            .label-addPadding {
                padding-left:20px !important;
            }
            .header {
                padding-top: 15px;
                font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 20px;
                font-weight: 400;
                letter-spacing: -.012em;
                line-height: 20px;
            }
            .warning {
                color: rgb(221, 44, 0) !important;
            }
        </style>
        <div class="display-flex column">
            <div class="paper-material" elevation="2">
                <div class="paper-material-inner display-flex border-top" style="background: #f5f5f5">
                    <div class="display-flex vertically-align image-holder">
                        <user-image fallback-value="[[username]]" email="[[email]]"></user-image>
                    </div>

                    <div class="display-flex column flex"
                         style="border-left: 1px solid #ccc; background: #fff; padding-left: 10px">
                        <div class="username-header flex" style="margin-right: 10px;">[[username]]</div>
                        <div class="org">
                            [[organisationName]]
                        </div>
                    </div>
                </div>
            </div>

            <div class="paper-material" elevation="1">
                <div class="paper-material-inner display-flex column">
                    <div class="display-flex row vertically-align">
                        <div class="label">Home directory path</div>
                        <div class="value flex">
                            [[homeDir]]
                        </div>
                        <paper-button class="btn" on-tap="_view" data-path$="[[homeDir]]">view</paper-button>
                    </div>
                    <div class="display-flex row vertically-align">
                        <div class="label">Root directory path</div>
                        <div class="value flex">
                            [[rootDir]]
                        </div>
                        <paper-button class="btn" on-tap="_view" data-path$="[[rootDir]]">view</paper-button>
                    </div>
                    <div class="display-flex row vertically-align">
                        <div class="label">Email address</div>
                        <div class$="[[_computedEmailCss(email)]]">[[email]]</div>
                    </div>
                    <div class="display-flex row vertically-align">
                        <div class="label">User identifier (UID)</div>
                        <div class="value">[[uid]]</div>
                    </div>
                    <div class="display-flex row vertically-align">
                        <div class="label">Group identifier (GID)</div>
                        <div class="value">[[gids]]</div>
                    </div>
                </div>
            </div>

            <div class="paper-material" elevation="1">
                <div style="padding-left: 10px;">
                    <div class="header">
                        Roles
                    </div>
                    <small style="color: #1c7cf1; font-size: 0.67em;">
                        These are optional switch that affect how dCache behaves
                    </small>
                </div>
                <div class="paper-material-inner display-flex column">
                    <div class="display-flex row vertically-align">
                        <div class="value flex">
                            Available role(s):
                        </div>
                        <paper-toggle-button id="allRolesAssertionToggle"
                                             on-change="_roleAssertion"
                                             data-roles="*"
                                             checked="[[_allCurrentStatus()]]"
                                             class$="[[_computedClass('all-roles')]]">Assert all roles
                        </paper-toggle-button>
                    </div>

                    <div class$="[[_computedClass('no-roles')]]" style="justify-content: center">
                        <div style="color: rgb(221, 44, 0);">
                            <iron-icon icon="visibility-off"></iron-icon>
                            <span> No roles to assert</span>
                        </div>
                    </div>
                    <template is="dom-repeat" items="[[listOfAllRoles]]">
                        <div class="display-flex row vertically-align">
                            <div class="label label-addPadding">[[item.role]]</div>
                            <div class="value flex"></div>
                            <paper-toggle-button on-change="_roleAssertion"
                                                 data-roles="[[item.role]]"
                                                 checked="[[item.assert]]"
                                                 class="toggleBtn"></paper-toggle-button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        class UserProfile extends Polymer.Element
        {
            constructor()
            {
                super();
                this.listOfAllRoles = this._getInitialListOfAllRoles();
            }
            static get is()
            {
                return 'user-profile';
            }
            static get properties()
            {
                return {
                    username: {
                        type: String,
                        notify: true,
                        value: function () {
                            return sessionStorage.getItem("name");
                        }
                    },
                    email: {
                        type: String,
                        notify: true,
                        value: function () {
                            return sessionStorage.getItem("email");
                        }
                    },
                    uid: {
                        type: String,
                        notify: true,
                        value: function () {
                            return sessionStorage.uid;
                        }
                    },
                    gids: {
                        type: String,
                        notify: true,
                        value: function () {
                            return sessionStorage.gids;
                        }
                    },
                    organisationName: {
                        type: String,
                        value: function () {
                            return window.CONFIG["dcache-view.org-name"];
                        },
                        notify: true
                    },
                    rootDir: {
                        type: String,
                        notify: true,
                        value: function () {
                            return sessionStorage.getItem("rootDirectory");
                        }
                    },
                    homeDir: {
                        type: String,
                        notify: true,
                        value: function () {
                            return sessionStorage.getItem("homeDirectory");
                        }
                    },
                    listOfAllRoles: {
                        type: Array,
                        notify: true,
                        value: function () {
                            return [];
                        }
                    }
                }
            }
            _view(e)
            {
                page.redirect("/");
                this.dispatchEvent(
                    new CustomEvent('dv-namespace-ls-path', {
                        detail: {path: e.target.getAttribute('data-path')}, bubbles: true, composed: true}));
            }

            _computedClass(str)
            {
                return this.listOfAllRoles.length === 0 ? str === "no-roles" ?
                    ' display-flex row vertically-align' : ' hide row' : str === "no-roles" ?
                    ' hide row' : str === "all-roles" ? this.listOfAllRoles.length === 1 ?
                        ' hide' : ' toggleBtn' : ' paper-material-inner display-flex column';
            }
            _computedEmailCss(email)
            {
                let classes = 'value flex';
                if (email === "not available") {
                    classes += ' warning';
                }
                return classes;
            }
            _allCurrentStatus()
            {
                const len = this.listOfAllRoles.length;
                let allRolesAsserted = true;
                for (let i = 0; i < len; i++) {
                    if (this.listOfAllRoles[i].assert === false) {
                        allRolesAsserted = false;
                        break;
                    }
                }
                return allRolesAsserted;
            }
            _roleAssertion(e)
            {
                const role = e.target.dataRoles === undefined ?
                    e.target.getAttribute('data-roles'): e.target.dataRoles;
                const toggle = e.target;

                const rolesAssertion = new RoleRequest();
                rolesAssertion.promise.then(response => {
                    const len = this.listOfAllRoles.length;
                    if (role === "*") {
                        for (let i = 0; i < len; i++) {
                            if (this.listOfAllRoles[i].assert === !toggle.active) {
                                this.set(`listOfAllRoles.${i}`, {assert: toggle.active});
                            }
                        }
                        this.dispatchEvent(new CustomEvent('dv-namespace-show-message-toast', {
                            detail: {message: response.detail.message}, bubbles: true, composed: true
                        }));
                    } else {
                        if (len > 1) {
                            let assert = 0, leave = 0;
                            for (let i = 0; i < len; i++) {
                                if (this.listOfAllRoles[i].assert === true) {
                                    assert += 1;
                                }
                                if (this.listOfAllRoles[i].assert === false) {
                                    leave += 1;
                                }
                            }
                            if (assert === len) {
                                this.$.allRolesAssertionToggle.checked = true;
                            }
                            if (leave === len) {
                                this.$.allRolesAssertionToggle.checked = false;
                            }
                        }
                    }
                    store(normaliseCredentialFormat(response.detail.credential));
                    this.dispatchEvent(new CustomEvent('dv-authentication-successful', {
                        detail: {
                            message: response.detail.message,
                            roles: response.detail.credential.roles === undefined ?
                                "": `${response.detail.credential.roles}`
                        }, bubbles: true, composed: true
                    }));
                }).catch(err => {
                    toggle.checked = !toggle.checked;
                    this.dispatchEvent(new CustomEvent('dv-namespace-show-message-toast', {
                        detail: {message: `${err}`}, bubbles: true, composed: true
                    }));
                });
                if (toggle.active) {
                    rolesAssertion.assert(role === "*"?`${sessionStorage.listOfPossibleRoles}`:role);
                } else {
                    rolesAssertion.leave(role);
                }
            }
            _getInitialListOfAllRoles()
            {
                const roles = sessionStorage.roles === "" ? [] : (sessionStorage.roles).split(",");
                const unAsserted = sessionStorage.listOfPossibleRoles === "" ?
                    [] : (sessionStorage.listOfPossibleRoles).split(",");
                return [...roles.map(str => {
                    if (str !== undefined || str !== "") return {"role": str, "assert": true};}),
                    ...unAsserted.map(str => {
                    if (str !== undefined || str !== "") return {"role": str, "assert": false};})
                ];
            }
        }
        window.customElements.define(UserProfile.is, UserProfile);
    </script>
</dom-module>