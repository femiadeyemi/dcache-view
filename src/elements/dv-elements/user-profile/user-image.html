<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="gravatar-request.html">
<link rel="import" href="identicon-request.html">

<dom-module id="user-image">
    <template>
        <style>
            :host {
                --user-image-border-radius: 0;
            }
            .container{
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;

            }
            paper-spinner {
                margin:auto;
                width: 20px;
                height: 20px;
            }
            .hide {
                display: none !important;
            }
            img {
                border-radius: var(--user-image-border-radius);
            }
        </style>
        <div class="container">
            <gravatar-request id="gravatar"
                              size="[[size]]"
                              on-gravatar-request-error="_gravatarResponseListener"
                              on-gravatar-request-successful="_gravatarResponseListener"></gravatar-request>
            <img id="avatar" width="{{size}}" height="{{size}}">
            <paper-spinner id="spinner" active="[[loading]]"></paper-spinner>
        </div>
    </template>
    <script>
        class UserImage extends Polymer.Element
        {
            static get is()
            {
                return 'user-image';
            }
            static get properties()
            {
                return {
                    email: {
                        type: String,
                        notify: true,
                    },
                    fallbackValue: {
                        type: String,
                        value: 'Anonymous',
                        notify: true,
                    },
                    size: {
                        type: Number,
                        Value: 60,
                        notify: true
                    },
                    loading: {
                        type: Boolean,
                        value: function () {
                            return window.CONFIG.avatarSrc === undefined || window.CONFIG.avatarSrc === "";
                        },
                        notify: true
                    },
                    src: {
                        type: String,
                        notify: true,
                    },
                    link: {
                        type: String,
                        notify: true,
                    }
                }
            }
            static get observers()
            {
                return [
                    '_srcChanged(src)',
                    '_visibility(loading)'
                ];
            }
            ready()
            {
                super.ready();
                Polymer.RenderStatus.afterNextRender(this, ()=> {
                    if (window.CONFIG.avatarSrc === undefined || window.CONFIG.avatarSrc === "") {
                        if (this.email===undefined || this.email === null || this.email === "") {
                            this.src = this._fallbackCall(this.fallbackValue);
                            return;
                        }
                        const gravatar = this.$.gravatar;
                        gravatar.request(this.email);

                        /**
                         * If no response is received from the request after 1.5 seconds,
                         * use the fallback option.
                         */
                        setTimeout(()=>{
                            if (!window.CONFIG.avatarSrc) {
                                this.src = this._fallbackCall(this.fallbackValue);
                            }
                        }, 1500);
                    } else {
                        this.src = window.CONFIG.avatarSrc;
                    }
                });
            }
            _gravatarResponseListener(e)
            {
                this.src = e.detail.link ? e.detail.link : this._fallbackCall(this.fallbackValue);
            }
            _srcChanged(n)
            {
                if (!(n === undefined || n === "")) {
                    this.loading = false;
                    this.$.avatar.src = n;
                    this.updateStyles();
                }
            }
            _fallbackCall(value)
            {
                const uIcon = new IdenticonRequest(value);
                uIcon.size = this.size;
                window.CONFIG.avatarSrc = uIcon.generateSrc();
                return uIcon.generateSrc();
            }
            _visibility(loading) {
                if (loading) {
                    this.$.avatar.classList.add('hide');
                    this.$.spinner.classList.remove('hide');
                } else {
                    this.$.avatar.classList.remove('hide');
                    this.$.spinner.classList.add('hide');
                }
            }
        }
        window.customElements.define(UserImage.is, UserImage);
    </script>
</dom-module>