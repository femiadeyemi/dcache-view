<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="user-login-page.html">

<dom-module id="user-loginout-button">
    <style>
        :host {
            align-self: center;
        }
        paper-button {
            text-transform: initial !important;
            font-size: 0.7em;
        }
        #logout {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding-right: 5px;
            padding-left: 5px;
        }
        #logout:hover {
            background: dimgray;
        }
        paper-dropdown-menu {
            width: 24px;
            --paper-dropdown-menu-icon: {
                fill: white;
            };
            --paper-input-container-underline: {
                display: none;
            };
            --paper-input-container-input: {
                display: none !important;
            };
        }
        .header {
            padding-bottom: 10px;
        }
        .collapse-content {
            padding: 5px;
            border: 1px solid #dedede;
            font-size: 0.7em;
            white-space:normal !important;
            max-width: 350px;
        }
        .uid, .gid, .hmdir, .role {
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
        }
        .uid > span, .gid > span, .hmdir > span, .role > span {
            flex:1;
            font-size: 0.7em;
            margin-left: 7px;
        }
        .guid {
            background: #efefef;
            border-top: 1px solid #424242;
        }
        .rotate {
            -webkit-animation-name: rotate;
            -webkit-animation-duration:3s;
            -webkit-animation-iteration-count: 1;
            -webkit-animation-timing-function: ease;
            -webkit-animation-fill-mode: forwards;
            animation-name: rotate;
            animation-duration:0.5s;
            animation-iteration-count: 1;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }
            to {
                -webkit-transform: rotate(180deg);
            }
        }
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(180deg);
            }
        }
        paper-icon-button {
            width: 34px;
            height: 34px;
            color: #333;
        }
        .usernameContainer {
            display: flex;
            background: #616161;
            color: lime;
            flex-direction: column;
            padding:5px;
        }
        .username > div {
            flex: 0 1 auto;
            max-width: 350px;
        }
        .username > div > code {
            word-wrap: break-word;
        }
        .show {
            display: block;
        }
        .hide {
            display: none;
        }
        .remove-border {
            border:none !important;
        }
    </style>
    <template>
        <paper-button on-tap="_login" id="login" style="border: 1px solid white;">log in</paper-button>
        <div id="logout" on-tap="_openDropdown">
            <iron-icon icon="icons:account-circle"></iron-icon>
            <paper-dropdown-menu id="logoutDropdown" noink no-animations no-label-float
                                 dynamic-align horizontal-align="left" vertical-align="bottom">
                <paper-listbox class="dropdown-content" style="padding: 0px !important;">
                    <paper-card>
                        <div class="card-content">
                            <div class="header">
                                <span style="font-size: 0.8em;margin-bottom: 3px;">Logged in as </span>
                                <div class="usernameContainer">
                                    <div>
                                        <code>
                                            {{username}}
                                        </code>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div on-tap="_hmdir" class="hmdir">
                                    <span>Home directory</span>
                                    <paper-icon-button icon="icons:expand-more" id="hmDirButton"></paper-icon-button>
                                </div>
                                <iron-collapse id="hmDir">
                                    <div class="collapse-content">{{homeDir}}</div>
                                </iron-collapse>
                            </div>
                            <div>
                                <div on-tap="_uid" class="uid">
                                    <span>User ID</span>
                                    <paper-icon-button icon="icons:expand-more" id="uidButton"></paper-icon-button>
                                </div>
                                <iron-collapse id="uid">
                                    <div class="collapse-content">{{uid}}</div>
                                </iron-collapse>
                            </div>
                            <div style="height:10px;"></div>
                            <div>
                                <div on-tap="_gid" class="gid">
                                    <span>Group IDs</span>
                                    <paper-icon-button icon="icons:expand-more" id="gidButton"></paper-icon-button>
                                </div>
                                <iron-collapse id="gid">
                                    <div class="collapse-content">{{gids}}</div>
                                </iron-collapse>
                            </div>
                            <div style="height:10px;"></div>
                            <div>
                                <div on-tap="_role" class="role">
                                    <span>Roles
                                        <iron-icon icon="icons:info" id="roleInfo"
                                                           style="width:15px;height: 15px; fill:#0e5aff"></iron-icon>
                                        <paper-tooltip for="roleInfo">
                                            List of roles available to you.
                                        </paper-tooltip>
                                    </span>
                                    <paper-icon-button icon="icons:expand-more" id="roleButton"></paper-icon-button>
                                </div>
                                <iron-collapse id="role">
                                    <div class$="[[_computedClass('collapse-content')]]">
                                        <span class$="[[_computedClass('span')]]">No roles</span>
                                        <div class$="[[_computedClass('div')]]">
                                            <template is="dom-repeat" items="[[unassertedRoles]]">
                                                <!-- TODO: need styling-->
                                                <paper-button class="[[_computedBtnClass(item)]]"
                                                              on-tap="_assertRole"
                                                              data-roles="[[item]]">{{item}}</paper-button>
                                            </template>
                                        </div>
                                    </div>
                                </iron-collapse>
                            </div>
                        </div>
                        <div class="card-actions">
                            <paper-button on-tap="_logout">Log out</paper-button>
                            <paper-button on-tap="_diffuser">Log in as a different user</paper-button>
                        </div>
                    </paper-card>
                </paper-listbox>
            </paper-dropdown-menu>
        </div>
    </template>
    <script>
        UserLoginoutButton = Polymer({
            is: 'user-loginout-button',
            properties: {
                upauth: {
                    type: String,
                    value: function () {
                        // TODO: Add functionality to support storing auth for longer period
                        return sessionStorage.upauth;
                    },
                    notify: true
                },
                username: {
                    type: String,
                    notify: true
                },
                uid: {
                    type: String,
                    notify: true
                },
                gids: {
                    type: String,
                    notify: true
                },
                homeDir: {
                    type: String,
                    notify: true
                },
                pgRoute: {
                    type: String,
                    notify: true
                },
                unassertedRoles: {
                    type: Array,
                    notify: true
                }
            },

            observers: [
                'authenticationCheck(upauth)'
            ],

            ready: function ()
            {
                if (typeof(Storage) === "undefined") {
                    app.$.toast.text = 'Sorry! No Web Storage support... ';
                    app.$.toast.show();
                }
                this.authenticationStatus(this.upauth);
            },

            authenticationCheck: function (upauth)
            {
                this.authenticationStatus(upauth);
            },

            _login: function()
            {
                let pathName;
                if (this.pgRoute === "home") {
                    const a = '"page":"home","path":"' + app.$.homedir.querySelector('view-file').path + '"';
                    pathName = '/user-login?r=' + encodeURIComponent(a);
                } else if (this.pgRoute === "admin-component-page") {
                    const a = '"page":"' + window.location.hash.substr(3) + '"';
                    pathName = '/user-login?r=' + encodeURIComponent(a);
                } else {
                    const a = '"page":"' + this.pgRoute + '"';
                    pathName = '/user-login?r=' + encodeURIComponent(a);
                }

                page(pathName);
            },

            _logout: function()
            {
                this.__clearSessionStorage();
                Polymer.dom.flush();
                this.updateStyles();
                window.location.reload();
            },

            _diffuser: function ()
            {
                this.__clearSessionStorage();
                this._login();
            },

            __clearSessionStorage: function ()
            {
                sessionStorage.clear();
                this.upauth = null;
                this.username = null;
                this.uid = null;
                this.gids = null;
                this.unassertedRoles = null;
                window.CONFIG.isSomebody = false;
                app.notifyPath('config.isSomebody');
            },

            _openDropdown: function ()
            {
                this.$.logoutDropdown.open();
            },

            authenticationStatus: function (upauth)
            {
                if ( upauth === null || upauth === "" || upauth === undefined ) {
                    this.$.login.hidden = false;
                    this.$.logout.hidden = true;
                } else {
                    this.$.login.hidden = true;
                    this.$.logout.hidden = false;
                    this.username = this._returnSessionValues("name");
                    this.uid = this._returnSessionValues("uid");
                    this.gids = this._returnSessionValues("gids");
                    this.homeDir = this._returnSessionValues("homeDirectory");
                    this.unassertedRoles = this._returnSessionValues("unassertedRoles").split(",");
                }
            },

            _returnSessionValues: function (item) {
                var a = sessionStorage.getItem(item);
                if (a != null || a !== undefined) {
                    return a;
                } else {
                    return "no " + item;
                }
            },

            _uid: function (e)
            {
                e.stopPropagation();
                this._showMore(this.$.uid, this.$.uidButton);
                e.stopPropagation();
            },

            _gid: function (e)
            {
                e.stopPropagation();
                this._showMore(this.$.gid, this.$.gidButton);
                e.stopPropagation();
            },
            _hmdir: function (e)
            {
                e.stopPropagation();
                this._showMore(this.$.hmDir, this.$.hmDirButton);
                e.stopPropagation();
            },
            _role: function (e)
            {
                e.stopPropagation();
                this._showMore(this.$.role, this.$.roleButton);
                e.stopPropagation();
            },
            _showMore: function (feCollapseNode, btn)
            {
                feCollapseNode.toggle();
                btn.parentNode.classList.toggle("guid");
                btn.classList.toggle("rotate");
            },

            _computedClass: function (element)
            {
                let x = sessionStorage.unassertedRoles;
                if (x === [] || x === undefined || x === null || x === "") {
                    //return element === "span" ? ' show' : ' hide';
                    return element === "span" ? ' show' : element === "div" ? ' hide' : ' collapse-content';
                } else {
                    //return element === "span" ? ' hide' : ' show';
                    return element === "span" ? ' hide' : element === "div" ? ' show' : ' collapse-content remove-border';
                }

                //collapse-content
            },

            _computedBtnClass: function(unassertedRole)
            {
                let assertedRoles = sessionStorage.roles;
                const len = assertedRoles.length;
                for (let i=0; i<len;i++) {
                    if (unassertedRole === assertedRole[i]) {
                        return ' asserted';
                    }
                }
            },

            _assertRole: function (e)
            {
                //TODO: display overlay
                if (sessionStorage.authType === "Basic") {
                    const role = e.target.getAttribute('data-roles');
                    const oldAuth = window.atob(sessionStorage.upauth);

                    const newUnencodedAuth = oldAuth.replace(sessionStorage.name,sessionStorage.name+"#" + role);
                    const b64EncodedAuth = window.btoa(newUnencodedAuth);
                    const redirectTo = {"page": "roleAssertion", "path": ""};
                    let userAuth = new UserAuthentication(redirectTo, b64EncodedAuth, sessionStorage.unassertedRoles);

                    userAuth.addEventListener('successful', (e) => {
                        //remove overlay
                        app.$.toast.text = e.detail.message + " ";
                        app.$.toast.show();
                    });

                    userAuth.addEventListener('error', (e) => {
                        //remove overlay
                        app.$.toast.text = e.detail.message + " ";
                        app.$.toast.show();
                    });

                    userAuth.send("Basic");
                } else {
                    //remove overlay
                    app.$.toast.text = 'Unsupported operation: You cannot assert a role with' +
                        sessionStorage.authType +
                        ' authentication method. Please login with username and password to assert a role. ';
                    app.$.toast.show();
                }
            }
        });
    </script>
</dom-module>