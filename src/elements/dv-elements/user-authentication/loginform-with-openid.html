<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="login-form.html">

<dom-module id="loginform-with-openid">
    <style>
        @media only screen and (max-width: 740px) {
            /* smaller screen: */
            :host {
                display: flex;
                margin-top: 16px;
            }

            #openIDs, #divider, login-form {
                width: 300px !important;
            }
            #openIDs paper-button {
                width: 300px !important;
                text-transform: none !important;
                background: #ccc;
                color: #373737;
                margin: 0;
            }
            #divider {
                box-sizing: border-box;
                display: flex;
                justify-content: center;
                margin-top: 20px;
            }
            #divider div {
                width: 100%;
                text-align: center;
                border-bottom: 1px solid #b0b0b0;
                line-height: 0.1em;
                margin: 10px 0 20px;
            }

            #divider div span {
                background: #686868;
                padding:0 10px;
                color: #fafafa;
                font-size: 12px;
                letter-spacing: 1px;
            }
            neon-animated-pages {
                flex: 1 auto;
            }
            neon-animatable:nth-child(1) {
                width: 300px;
                margin: 16px auto;
            }

            /* TODO:  below is the sama with the larger screen setting; factor out */
            neon-animatable:nth-child(2) {
                display: flex;
                flex-direction: column;
                align-items: center;
                height: calc(100vh - 25vh - 89px);
                margin-top: -16px;
            }
            neon-animatable:nth-child(2) #providersContainer {
                box-sizing: border-box;
                margin: 10px;
                max-height: calc(100vh - 25vh - 89px - 75px);
                padding-bottom: 45px;
                overflow-y: scroll;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            #providersContainer paper-button {
                background: #ccc;
                color: #383838;
                margin: 0.5em;
                padding: 0.5em 1em;
                max-width: 300px !important; /* TODO: remember to add ellipsis */
            }
        }
        @media only screen and (min-width: 740px) {
            /* larger screen: */
            :host {
                display: flex;
                margin-top: 16px;
            }

            login-form {
                width: 300px !important;
            }
            #openIDs paper-button {
                width: 300px !important;
                text-transform: none !important;
                background: #ccc;
                color: #373737;
                margin: 0;
            }

            #divider {
                height: 200px;
                width: 50px;
            }
            #divider div {
                position: relative;
                height: 200px;
                text-align: center;
            }
            #divider div:after {
                content: " ";
                position: absolute;
                left: 50%;
                height: 100%;
                border-left: 1px solid #b0b0b0;
            }
            #divider div span {
                position: absolute;
                left: 50%;
                top: 50%;
                padding: 5px;
                color: #fafafa;
                font-size: 12px;
                letter-spacing: 1px;
                background: #686868;
                transform: translateX(-50%) translateY(-50%);
                z-index: 1;
            }

            neon-animated-pages {
                flex: 1 auto;
            }
            neon-animatable{
                display: flex;
            }
            neon-animatable:nth-child(1) {
                margin-top: 15px;
                height: 200px;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
            }

            neon-animatable:nth-child(2) {
                flex-direction: column;
                align-items: center;
                height: calc(100vh - 25vh - 89px);
                margin-top: -16px;
            }
            neon-animatable:nth-child(2) #providersContainer {
                box-sizing: border-box;
                margin: 10px;
                max-height: calc(100vh - 25vh - 89px - 75px);
                padding-bottom: 45px;
                overflow-y: scroll;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            #providersContainer paper-button {
                background: #ccc;
                color: #383838;
                margin: 0.5em;
                padding: 0.5em 1em;
                max-width: 300px !important; /* TODO: remember to add ellipsis */
            }
        }
    </style>
    <template>
        <neon-animated-pages id="pages" selected="[[selected]]" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
            <neon-animatable>
                <div id="openIDs">
                    <paper-button on-tap="_showAllAvailableProviders">Login via an OpenID account</paper-button>
                </div>
                <div id="divider">
                    <div>
                        <span>OR</span>
                    </div>
                </div>
                <login-form redirect-to="[[redirectTo]]"></login-form>
            </neon-animatable>
            <neon-animatable>
                <div style="margin-top: 7px; margin-bottom: 5px">
                    <div style="width:40px;height: 40px; border: 2px solid #d6d6d6; border-radius: 22px; color: #d6d6d6;">
                        <paper-icon-button icon="chevron-left" on-tap="_backToMain">back</paper-icon-button>
                    </div>
                </div>
                <div style="color:#b5b5b5; font-size: 0.9em; letter-spacing: 1px;line-height: 2em;">
                    Supported OpenID Providers
                </div>
                <br>
                <div id="providersContainer">
                    <!-- TODO: style the buttons based on the provider's (logo/style/theme) -->
                    <template is="dom-repeat" items="{{openIDproviders}}">
                        <paper-button on-tap="_connect" data-id$="[[item.id]]"
                                      data-endpoint$="[[item.endpoint]]" style="text-transform: none !important;">
                            Login via&nbsp;<label style="text-transform: capitalize !important;">{{item.name}}</label>
                        </paper-button>
                    </template>
                </div>
            </neon-animatable>
        </neon-animated-pages>
    </template>
    <script>
        LoginformWithOpenid = Polymer({
            is: "loginform-with-openid",

            properties: {
                openIDproviders: {
                    type: Array,
                    notify: true
                },
                selected: {
                    type: Number,
                    value: 0,
                    notify: true
                },
                redirectTo: {
                    type: Object,
                    notify: true
                }
            },

            ready: function()
            {
                let a = window.CONFIG.oidcProviderName.trim().split(" ");
                let b = window.CONFIG.oidcClientId.trim().split(" ");
                let c = window.CONFIG.oidcAuthorizationEndpoint.trim().split(" ");
                const len = a.length;
                let jsonString = '';
                for (let i=0; i<len; i++) {
                    jsonString += '{"name":"' + a[i] + '", "id":"' + b[i] + '", "endpoint":"' + c[i] + '"},';
                }

                this.openIDproviders = [JSON.parse(jsonString.slice(0,-1))];

            },

            _showAllAvailableProviders: function ()
            {
                this.entryAnimation = 'slide-from-right-animation';
                this.exitAnimation = 'slide-left-animation';
                this.selected = 1;
            },

            _backToMain: function()
            {
                this.entryAnimation = 'slide-from-left-animation';
                this.exitAnimation = 'slide-right-animation';
                this.selected = 0;
            },

            _connect: function (e)
            {
                sessionStorage.removeItem('nonce');
                const id = e.target.getAttribute('data-id');
                const endpoint = e.target.getAttribute('data-endpoint').endsWith('?')
                    ? e.target.getAttribute('data-endpoint') : e.target.getAttribute('data-endpoint') + '?';
                const redirecturi = encodeURIComponent(window.location.origin);
                let nonce = this._generateNonce();
                nonce = window.btoa(this._entropy(nonce));
                sessionStorage.setItem("nonce", nonce);

                sessionStorage.removeItem('redirect');
                sessionStorage.setItem('redirect', JSON.stringify(this.redirectTo));

                window.location.href = endpoint + 'response_type=id_token%20token' +
                    '&client_id=' + id +
                    '&redirect_uri=' + redirecturi +
                    '&scope=openid%20profile%20email' +
                    '&nonce=' + nonce +
                    '&prompt=consent';
            },

            /**
             * Consider moving @this._entropy & @this._generateNonce into dv.js
             */
            _entropy: function(str)
            {
                let a = str.split(""),
                    len = a.length;

                for (let i = len - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1));
                    let tmp = a[i];
                    a[i] = a[j];
                    a[j] = tmp;
                }
                return a.join("");
            },

            _generateNonce: function()
            {
                let ints = new Uint32Array(8);
                window.crypto.getRandomValues(ints);
                let nonce = "";
                ints.forEach(int => {
                    nonce = nonce + int.toString(36);
                });

                return nonce;
            }
        })
    </script>
</dom-module>