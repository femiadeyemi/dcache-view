<link rel="import" href="../../../bower_components/polymer/polymer.html">

<script src="../../../bower_components/qrjs/qr.js"></script>
<script src="../../../bower_components/qr-code/src/qr-code.js"></script>
<dom-module id="file-sharing-dialog-content">
    <template>
        <style>
            :host {
                width: 400px;
                max-height: 500px;
                padding: 0 !important;
                margin: 0 !important;
            }
            #mainWrapper{
                width: 400px;
                padding: 10px !important;
                overflow: scroll;
            }
            .headerContainer {
                display: flex;
                height: 50px;
                align-items: center;
                border-bottom: 1px solid #d6d6d6;
                margin-bottom: 20px;
                background-color: #fff;
                color: #333;
            }
            .flex {
                flex-grow: 1;
            }
            .flex2 {
                flex-grow: 2;
            }
            #qrPicture, #linkDisplay {
                display: none;
            }
            #genQR {
                background-color: #0e5aff;
                color: white !important;
            }
            paper-fab {
                --paper-fab-background: #FF5722;
                --paper-fab-keyboard-focus-background: #BF360C;
            }
        </style>
        <iron-ajax id="ajax"
                   method="POST"
                   handle-as="json" on-response="_handleResponse"
                   on-error="_handleError" loading="{{loading}}"></iron-ajax>
        <div id="mainWrapper">
            <div class="headerContainer">
                <div class="flex"><h3>Share with others</h3></div>
                <span class="flex2"></span>
                <paper-icon-button id="closeBtn" icon="close" dialog-dismiss></paper-icon-button>
            </div>
            <div>
                <div class="flex">
                    <span>
                        Generate a shareable link for the file <code style="color: red;">[[fileName]]</code>.
                    </span>
                </div>
                <br>
                <br>
                <div style="display: flex; align-items: center;">
                    <div style="height:100px; width: 150px;" >
                        <qr-code id="qrPicture" data="[[generatedLink]]" modulesize="2" margin="1" format="html"></qr-code>
                    </div>
                    <div>
                        <div class="buttons">
                            <paper-button dialog-dismiss>Cancel</paper-button>
                            <paper-button id="linkBtn" on-tap="_getLink" raised>Get the link</paper-button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="loading">
                <paper-spinner alt="waiting for response" active="{{loading}}"></paper-spinner>
            </div>

            <div id="linkDisplay">
                <div id="resultContainer" style="margin-bottom: 5px;">
                    <div id="link" style="width: 380px !important;">
                        <textarea id="linkWrapper" readonly
                                  style="width: 380px; height: 50px; word-wrap:
                                    break-word; text-align: justify; text-justify: inter-word;
                                    text-indent: 0px; !important; text-align: left;">
                            [[generatedLink]]
                        </textarea>
                    </div>
                </div>

                <div style="display: flex">
                    <paper-button id="genQR" on-tap="_generateQR" raised>Generate QR Code</paper-button>
                    <span class="flex"></span>
                    <paper-fab on-tap="_copy" icon="link" title="Copy link"></paper-fab>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'file-sharing-dialog-content',
            properties: {
                loading: {
                    type: Boolean,
                    notify: true
                },
                filePath: {
                    type: String,
                    notify: true
                },
                fileName: {
                    type: String,
                    notify: true,
                    computed:'_computeFileName(filePath)'
                },
                parentPath: {
                    type: String,
                    notify: true,
                    computed:'_computeParentPath(filePath)'
                },
                generatedLink: {
                    type: String,
                    notify: true
                },
            },

            _computeFileName: function (pt)
            {
                let name;
                if (pt === "/") {
                    name = 'Root'
                } else {
                    name = pt.substr(pt.lastIndexOf("/")+1);
                }
                return name;
            },

            _computeParentPath: function (pt)
            {
                return pt.substr(0, pt.lastIndexOf("/"));
            },

            _getLink: function ()
            {
                this.loading = true;
                let auth = app.getAuthValue();

                this.$.ajax.url = 'https://localhost:2881'+this.filePath;

                this.$.ajax.headers = {
                    "Content-Type": "application/macaroon-request",
                    "Authorization": auth
                };
                this.$.ajax.generateRequest();
            },

            _handleResponse: function (e)
            {
                let m = e.detail.response.macaroon;
                let s = window.location.href+'#!/filesharing?filePath='+ encodeURIComponent(this.filePath) + '&m='+m;

                this.generatedLink = s.trim() ;

                this.$.linkDisplay.style.display = 'block';

                this.$.linkWrapper.select();

                this.loading = false;

            },

            _handleError: function (e)
            {
                app.$.toast.text = e.message;
                app.$.toast.show();
            },

            _copy: function ()
            {
                let copiedLink = this.$.linkWrapper;
                copiedLink.select();

                try {
                    let successful = document.execCommand('copy');
                    let msg = successful ? 'successful' : 'unsuccessful';
                    app.$.toast.text = 'Link copied ' + msg;
                    app.$.toast.show();
                } catch (err) {
                    app.$.toast.text = 'Oops, unable to copy';
                    app.$.toast.show();
                }
            },

            _generateQR: function ()
            {
                this.$.qrPicture.style.display = 'block';
            }
        })
    </script>

</dom-module>