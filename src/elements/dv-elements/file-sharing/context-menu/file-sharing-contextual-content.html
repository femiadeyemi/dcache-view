<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-icon-item.html">

<link rel="import" href="../../files-viewer/files-viewer.html">
<link rel="import" href="../../qbi-dialog-content/qbi-dialog-content.html">
<link rel="import" href="../../file-sharing/file-sharing-dialog-box/file-sharing-form.html">
<dom-module id="file-sharing-contextual-content">
    <template>
        <style>
            :host {
                display: block;
                box-sizing: border-box;
                max-width:100%;
            }
            :host paper-listbox {
                margin: -20px;
                padding: 0;
                background: transparent;
            }
            paper-icon-item:hover{
                background: #1565C0;
                color: #fff;
                border-radius: 4px;
                --paper-item-icon: {
                    color: #fff;
                }
            }
            paper-icon-item {
                font-size: 0.7em;
                min-height: 30px;
                font-weight: normal;
                padding-right: 0;
                padding-left: 5px;
                --paper-item-icon: {
                    width: 20px;
                    height: 20px;
                    margin-right: 10px;
                    color: #4e4e4e;
                }
            }
            paper-icon-item[disabled] > iron-icon {
                color: #b7b7b7;
            }
            .none {
                display: none;
            }
            #open {
                border-bottom: 1px solid #cacaca;
            }
            #delete, #download {
                border-top: 1px solid #cacaca;
            }
            #arrow {
                --iron-icon-width: 20px;
                --iron-icon-height: 20px;
                margin-left: 75px;
            }
        </style>
        <paper-listbox>
            <paper-icon-item  id="open" disabled>
                <iron-icon icon="visibility" slot="item-icon"></iron-icon>
                [[openOrView]]
            </paper-icon-item>

            <paper-icon-item id="changeQos" disabled>
                <iron-icon icon="settings-input-composite" slot="item-icon"></iron-icon>
                Change QoS
                <iron-icon id="arrow" icon="av:play-arrow"></iron-icon>
            </paper-icon-item>

            <paper-icon-item  id="share" disabled>
                <iron-icon icon="social:share" slot="item-icon"></iron-icon>
                Share
            </paper-icon-item>
            <paper-icon-item id="rename" disabled>
                <iron-icon icon="editor:border-color" slot="item-icon"></iron-icon>
                Rename
            </paper-icon-item>

            <paper-icon-item id="download" disabled>
                <iron-icon icon="cloud-download" slot="item-icon"></iron-icon>
                Download
            </paper-icon-item>

            <paper-icon-item id="metadata" disabled>
                <iron-icon icon="info" slot="item-icon"></iron-icon>
                View details
            </paper-icon-item>

            <paper-icon-item id="delete">
                <iron-icon icon="delete" slot="item-icon"></iron-icon>
                Remove from the list
            </paper-icon-item>
        </paper-listbox>
    </template>
    <script>
        class FileSharingContextualContent extends Polymer.Element
        {
            constructor(t)
            {
                super();
                this.targetNode = t;
                this.isExpired = new Date().getTime() - new Date(t.before).getTime() > 0;
            }
            static get is()
            {
                return 'file-sharing-contextual-content';
            }
            static get properties()
            {
                return {
                    targetNode: {
                        type: Object
                    },
                    openOrView: {
                        type: String,
                        notify: true
                    },
                    isExpired: {
                        type: Boolean,
                        notify: true
                    }
                }
            }
            connectedCallback()
            {
                super.connectedCallback();
                this.$.delete.addEventListener('tap', this._delete.bind(this));
                if (!this.isExpired) {
                    this.$.metadata.addEventListener('tap', this._metadata.bind(this));
                    this.$.rename.addEventListener('tap', this._rename.bind(this));
                    this.$.share.addEventListener('tap', this._share.bind(this));

                    this.$['metadata'].removeAttribute('disabled');
                    this.$['rename'].removeAttribute('disabled');
                    this.$['share'].removeAttribute('disabled');
                    this.$['open'].removeAttribute('disabled');

                    switch (this.targetNode.fileMetaData.fileType) {
                        case "DIR":
                            this.openOrView = 'Open';
                            this.$.open.addEventListener('tap', this._openOrDownload.bind(this));
                            break;
                        case "REGULAR":
                            if (this.targetNode.fileMetaData.fileMimeType.includes('video') ||
                                this.targetNode.fileMetaData.fileMimeType.includes('audio')) {
                                this.openOrView = 'Play';
                            } else {
                                this.openOrView = 'View';
                            }
                            this.$.download.addEventListener('tap', this._openOrDownload.bind(this));
                            this.$.open.addEventListener('tap', this._view.bind(this));
                            this.$['download'].removeAttribute('disabled');
                            break;
                    }
                } else {
                    this.openOrView = "Open/View/Play";
                }

                [...this.shadowRoot.querySelectorAll('paper-icon-item')].forEach(nd => {
                    nd.addEventListener('mouseenter', (e)=>{this._mouseEnter(e)});
                });
            }
            disconnectedCallback()
            {
                super.disconnectedCallback();
                this.$.delete.removeEventListener('tap', this._delete.bind(this));
                if (!this.isExpired) {
                    this.$.metadata.removeEventListener('tap', this._metadata.bind(this));
                    this.$.rename.removeEventListener('tap', this._rename.bind(this));
                    this.$.share.removeEventListener('tap', this._share.bind(this));

                    switch (this.targetNode.fileMetaData.fileType) {
                        case "DIR":
                            this.$.open.removeEventListener('tap', this._openOrDownload.bind(this));
                            break;
                        case "REGULAR":
                            this.$.download.removeEventListener('tap', this._openOrDownload.bind(this));
                            this.$.open.removeEventListener('tap', this._view.bind(this));
                            break;
                    }
                }

                [...this.shadowRoot.querySelectorAll('paper-icon-item')].forEach(nd => {
                    nd.removeEventListener('mouseenter', (e)=>{this._mouseEnter(e)});
                });
            }
            _mouseEnter(e)
            {
                if (window.CONFIG.isSomebody && e.composedPath()[0].id === "changeQos") {
                    this.dispatchEvent(
                        new CustomEvent('dv-namespace-open-subcontextmenu', {
                            detail: {targetNode: this.targetNode}, bubbles: true, composed: true}));
                }
                if (e.composedPath()[0].id !== "changeQos") {
                    this.dispatchEvent(new CustomEvent('dv-namespace-close-subcontextmenu', {
                        bubbles: true, composed: true
                    }));
                }
            }

            _openOrDownload()
            {
                // DONE
                this.dispatchEvent(new CustomEvent('dv-namespace-close-centralcontextmenu', {
                    bubbles: true, composed: true
                }));
                this.dispatchEvent(
                    new CustomEvent('dv-file-sharing-open-file', {
                        detail: {file: this.targetNode}, bubbles: true, composed: true}));
            }

            _rename()
            {
                //DONE
                this.dispatchEvent(new CustomEvent('dv-namespace-close-centralcontextmenu', {
                    bubbles: true, composed: true
                }));
                this.dispatchEvent(
                    new CustomEvent('dv-file-sharing-open-rename-dialogbox', {
                        detail: {file: this.targetNode}, bubbles: true, composed: true}));
            }
            _share()
            {
                //DONE
                this.dispatchEvent(new CustomEvent('dv-namespace-close-centralcontextmenu', {
                    bubbles: true, composed: true
                }));
                const fileSharingForm =
                    new FileSharingForm(this.targetNode.fileMetaData.fileName, this.targetNode.filePath);
                this.dispatchEvent(
                    new CustomEvent('dv-namespace-open-central-dialogbox', {
                        detail: {node: fileSharingForm}, bubbles: true, composed: true})
                );
            }
            _metadata()
            {
                //FIXME - inconsistent behaviour
                this.dispatchEvent(new CustomEvent('dv-namespace-close-centralcontextmenu', {
                    bubbles: true, composed: true
                }));

                this.dispatchEvent(
                    new CustomEvent('dv-namespace-open-filemetadata-panel', {
                        detail: {file: this.targetNode}, bubbles: true, composed: true}));
            }
            _delete()
            {
                //DONE
                this.dispatchEvent(new CustomEvent('dv-namespace-close-centralcontextmenu', {
                    bubbles: true, composed: true
                }));
                this.dispatchEvent(new CustomEvent('dv-namespace-file-sharing-remove-items', {
                    detail: {files: [this.targetNode]}, bubbles: true, composed: true
                }));
            }
            _view()
            {
                //FIXME: partially done. At least PDF viewer is not working
                this.dispatchEvent(new CustomEvent('dv-namespace-close-centralcontextmenu', {
                    bubbles: true, composed: true
                }));
                const viewer = new FilesViewer(this.targetNode, {"scheme": "Bearer", "value": this.targetNode.macaroon});
                this.dispatchEvent(
                    new CustomEvent('dv-namespace-open-files-viewer', {
                        detail: {node: viewer}, bubbles: true, composed: true
                    })
                );
            }
        }
        window.customElements.define(FileSharingContextualContent.is, FileSharingContextualContent);
    </script>
</dom-module>