<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../bower_components/file-icon/file-icon.html">

<link rel="import" href="../utils/ajax-ls/view-file.html">
<link rel="import" href="../drag-and-drop/dnd-upload.html">

<dom-module id="list-row">
    <template>
        <style>
            :host {
                @apply(--layout-block);
                font-size: 0.7em;
            }
            :host([x-selected]) {
                background-color: #2196F3 !important;
                color: #fff !important;
            }
            :host([x-selected]) .row {
                border-bottom: 1px solid #2196F3;
            }
            .row {
                @apply(--layout-horizontal);
                @apply(--layout-center);
                height: 40px;
                border-bottom: 1px solid #e5e5e5;
                text-decoration: none !important;
            }
            .name{
                @apply(--layout-flex-3);
            }
            .ctime, .qos {
                @apply(--layout-flex);
            }
            .size {
                @apply(--layout-flex);
                text-align: right;
            }
            .size > span {
                padding-right: 10px;
            }
            .fit {
                @apply(--layout-fit);
            }
            @keyframes blink-animation {
                to {visibility: hidden;}
            }
            @-webkit-keyframes blink-animation {
                to {visibility: hidden;}
            }
            #fileName {
                min-width:10px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            #nameContainer {
                display: flex;
                align-items: center;
                padding-right: 24px;
            }

            paper-icon-button {
                width: 34px !important;
                height: 34px !important;
                color: rgba(0, 0, 0, 0.54);
                --paper-icon-button-hover: {
                    color: #f09300 !important;
                };
            }
            .none {
                display: none;
            }
        </style>
        <div id="row" class="row">
            <file-icon mime-type="{{fileMimeType}}" style="padding-left: 15px; padding-right: 10px"></file-icon>
            <div class="cell name">
                <div id="nameContainer">
                    <span id="fileName" style="padding-left:5px;">{{name}}</span>
                </div>
            </div>
            <div class="cell ctime">{{computedCTime}}</div>
            <div class="cell qos"><i>{{qosValue}}</i></div>
            <div class="cell size" id="hovering">
                <span>{{computedSize}}</span>
            </div>
        </div>
    </template>
    <script>
        class ListRow extends Polymer.Element
        {
            static get is()
            {
                return 'list-row';
            }

            static get properties()
            {
                return {
                    name: {
                        type: String,
                        notify: true
                    },

                    fileType: {
                        type: String,
                        notify: true
                    },

                    fileMimeType: {
                        type: String,
                        notify: true
                    },

                    ctime: {
                        type: String,
                        notify: true
                    },

                    computedCTime: {
                        type: String,
                        computed:'_computedCTime(ctime)'
                    },

                    mtime: {
                        type: String,
                        notify: true
                    },

                    size: {
                        type: String,
                        notify: true
                    },

                    computedSize: {
                        type: String,
                        computed:'_computeSize(fileType, size)'
                    },

                    parentPath: {
                        type: String,
                        notify: true
                    },

                    filePath: {
                        type: String,
                        computed:'_computeFilePath(parentPath, name)'
                    },

                    currentQos: {
                        type: String,
                        notify: true
                    },

                    qosValue: {
                        type: String,
                        notify: true,
                        computed: '_computeQoSValue(currentQos)'
                    },

                    fileMData: {
                        type: Object,
                        notify: true
                    },

                    counter: {
                        type: Number,
                        value: 0,
                        notify: true
                    },

                    xSelected: {
                        type: Boolean,
                        notify: true,
                        reflectToAttribute: true
                    }
                }
            }

            connectedCallback()
            {
                super.connectedCallback();
                this.$.row.addEventListener('dblclick', ()=>{this._openFileLoc()});
                this.$.row.addEventListener('contextmenu', (e)=>{this._openContextMenu(e)});

                this.addEventListener('drop', (e)=>{this._drop(e)});
                this.addEventListener('dragenter', (e)=>{this._dragenter(e)});
                this.addEventListener('dragleave', (e)=>{this._dragleave(e)});
                this.addEventListener('dragstart', (e)=>{this._dragstart(e)});
            }

            disconnectedCallback()
            {
                super.disconnectedCallback();
                this.$.row.removeEventListener('dblclick', ()=>{this._openFileLoc()});
                this.$.row.removeEventListener('contextmenu', (e)=>{this._openContextMenu(e)});

                this.removeEventListener('drop', (e)=>{this._drop(e)});
                this.removeEventListener('dragenter', (e)=>{this._dragenter(e)});
                this.removeEventListener('dragleave', (e)=>{this._dragleave(e)});
                this.removeEventListener('dragstart', (e)=>{this._dragstart(e)});
            }

            _drop(event)
            {
                event.stopPropagation();
                event.preventDefault();

                if (this.fileType === 'DIR') {
                    this.counter = 0;
                    app.clearDelayedLs();
                    if (event.dataTransfer.types.includes('text/plain')) {
                        app.dragNdropMoveFiles(this.filePath, true);
                        this.classList.remove('selected');
                    } else {
                        app.$.dropZoneToast.close();
                        let upload = new DndUpload(this.filePath);
                        upload.isCurrentView = false;
                        upload.start(event);
                    }
                }
                event.stopPropagation();
            }

            _dragenter(event)
            {
                event.stopPropagation();
                event.preventDefault();
                if ( this.fileType === "DIR" ) {
                    this.counter++;
                    if (!event.dataTransfer.types.includes('text/plain')) {
                        app.$.dropZoneContent.querySelector('drag-enter-toast').directoryName =
                            this.name;
                        if (!app.$.dropZoneToast.opened) {
                            app.$.dropZoneToast.open();
                        }
                    }
                    this.classList.add('selected');
                    app.delayTact(this);
                }
                event.stopPropagation();
            }

            _dragleave(event)
            {
                event.stopPropagation();
                event.preventDefault();
                if ( this.fileType === "DIR" ) {
                    this.counter--;
                    if (this.counter === 0) {
                        this.classList.remove('selected');
                        app.clearDelayedLs();
                    }
                }
                event.stopPropagation();
            }

            _dragstart(event)
            {
                app.mvObj = {};
                app.notifyPath('mvObj');

                let vf = app.$.homedir.querySelector('view-file');
                if (vf.selectedItems.constructor === Array) {
                    app.mvObj.files= vf.selectedItems;
                } else {
                    app.mvObj.files = [vf.selectedItems];
                }
                app.mvObj.source = this.parentPath;
                app.notifyPath('mvObj');

                event.dataTransfer.setData('text/plain', 'draggable');
            }

            _computeFilePath(parentPath, name)
            {
                return parentPath + name;
            }

            _computeQoSValue(qos)
            {
                switch (qos) {
                    case "disk":
                        return "Disk";
                    case "tape":
                        return "Tape";
                    case "disk+tape":
                        return "Disk & Tape";
                    case "unavailable":
                        return "unavailable";
                }
            }

            _computedCTime(ctime)
            {
                var x = new Date(ctime);
                return x.toLocaleString();
            }

            _computeSize(fileType, size)
            {
                if ( fileType == "DIR" ) {
                    return  "--";
                } else {
                    if (size == 0) {
                        return "0 Byte";
                    }

                    var k = 1000;
                    var dm = 1 || 3;
                    var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    var i = Math.floor(Math.log(size) / Math.log(k));

                    return parseFloat((size / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                }
            }

            _openFileLoc()
            {
                if ( this.fileType == "DIR" ) {
                    app.ls(this.filePath);
                    Polymer.dom.flush();
                } else {
                    //Download a file
                    let path;
                    const webdav = window.CONFIG["dcache-view.endpoints.webdav"];
                    if (webdav == "") {
                        path = window.location.protocol + "//" + window.location.hostname + ":2880" + this.filePath;
                    } else {
                        if (webdav.endsWith("/")) {
                            path = webdav.substring(0, webdav.length-1) + this.filePath;
                        } else {
                            path = webdav + this.filePath;
                        }
                    }
                    window.open(path);
                }
            }

            _openContextMenu(event)
            {
                event.preventDefault();
                event.stopPropagation();
                /**
                 * A WORKAROUND for firefox
                 * TODO: When firefox support web components fully, revisit.
                 */
                this.dispatchEvent(new MouseEvent('contextmenu', {
                    view: window,
                    bubbles: true,
                    composed: true,
                    cancelable: true,
                    clientX: event.clientX,
                    clientY: event.clientY
                }));
            }
        }
        window.customElements.define(ListRow.is, ListRow);
    </script>
</dom-module>