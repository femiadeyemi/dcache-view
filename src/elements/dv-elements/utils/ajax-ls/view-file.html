<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../../../../bower_components/dcache-namespace/dcache-namespace.html">

<link rel="import" href="../../list-view/list-row.html">
<link rel="import" href="../../directory-ls-message/empty-directory.html">
<link rel="import" href="../../directory-ls-message/directory-ls-error.html">
<link rel="import" href="../../user-authentication/user-login-page.html">

<dom-module id="view-file">
    <template>
        <style>
            :host {
                display: block;
                max-height: 100vh;
                display: flex;
                flex-direction: column;
                /*Prevent text selection after double click*/
                -webkit-user-select: none; /* webkit (safari, chrome) browsers */
                -moz-user-select: none; /* mozilla browsers */
                -khtml-user-select: none; /* webkit (konqueror) browsers */
                -ms-user-select: none; /* IE10+ */
            }
            .item {
                text-decoration: none !important;
                background-color: white;
                @apply(--layout-flex);
                cursor:pointer;
            }
            .item:focus {
                outline: 0 solid transparent !important;
            }
            iron-list {
                flex: 1 1 auto;
            }
            .loading {
                text-align: center;
                height: 40px;
            }
            .loading paper-spinner {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
        </style>
        <iron-ajax id="ajax"
                   method="GET"
                   content-type="application/json"
                   handle-as="json" on-response="handleResponse"
                   on-error="handleError" loading="{{loading}}">
        </iron-ajax>
        <paper-material id="content" elevation="1">
            <iron-list id="feList" items="[]"
                       selected-item="{{selectedItem}}"
                       selection-enabled>
                <template>
                    <div>
                        <list-row class$="[[_computedClass(selected)]]" tabindex$="[[tabIndex]]"
                                  x-selected$="[[__computedXselected(item.xSelected)]]"
                                  name="{{item.fileName}}" file-type="{{item.fileType}}"
                                  ctime="{{item.creationTime}}" mtime="{{item.mtime}}"
                                  size="{{item.size}}" current-qos="{{item.currentQos}}"
                                  file-mime-type="{{item.fileMimeType}}" file-m-data="{{item}}"
                                  parent-path="[[parent]]" draggable="[[_computedDraggable(item.xSelected)]]">
                        </list-row>
                    </div>
                </template>
            </iron-list>
        </paper-material>
        <paper-dialog id="dialog"
                      horizontal-align="left" vertical-align="top"
                      style="margin:0; width:400px; background-color:#eee;">
            <div style="padding-top:0;padding-bottom:0;margin-top:0;margin-left:0;margin-right:0;">
                <iron-a11y-keys target="[[target]]"
                                keys="enter" on-keys-pressed="_rename">
                </iron-a11y-keys>
                <paper-input id="input" value="{{name::input}}"
                             auto-validate pattern="[^/]*" preventInvalidInput
                             error-message="Invalid name" required autofocus>
                </paper-input>
            </div>
        </paper-dialog>
        <div class="loading" id="loading">
            <paper-spinner alt="Loading data" active="{{loading}}"></paper-spinner>
        </div>

        <iron-scroll-threshold id="threshold"
                               lower-threshold="500"
                               on-lower-threshold="_loadNamespaceData">
        </iron-scroll-threshold>
    </template>

    <script>
        class ViewFile extends Polymer.Element
        {
            constructor(path)
            {
                super();
                this.path = path === undefined ? "/" : path;

                window.dispatchEvent(
                    new CustomEvent('dv-namespace-view-file-created', {
                        detail: {}, bubbles: true, composed: true}));
            }
            ready()
            {
                super.ready();
                var target = app.$.homedir.parentNode;
                this.$.feList.scrollTarget = target;
                this.$.threshold.scrollTarget = target;
                this.target = this.$.input;
            }
            connectedCallback()
            {
                super.connectedCallback();

                this.addEventListener('keydown', (e)=>{this._multipleSelectionShortcuts(e)});
                this.addEventListener('keyup', (e)=>{this._resetMultipleSelectionShortcuts(e)});
                window.addEventListener('dv-namespace-remove-items', (e)=>{this._removeItems(e)});
                window.addEventListener('dv-namespace-add-items', (e)=>{this._addItems(e)});
                window.addEventListener('dv-namespace-request-current-path', (e)=>{this._sendCurrentPath(this.path)});

                window.addEventListener('dv-namespace-request-item-index', (e)=>{this._sendItemIndex(e)});

                window.addEventListener('dv-namespace-reset-element-internal-parameters', (e)=>{this._reset(e)});

                this.addEventListener('click', (e)=>{
                    e.stopPropagation();
                });

                this.$.loading.addEventListener('contextmenu', (e)=>{this._openContextMenu(e)});
            }
            disconnectedCallback()
            {
                super.disconnectedCallback();
                this.removeEventListener('keydown', (e)=>{this._multipleSelectionShortcuts(e)});
                this.removeEventListener('keyup', (e)=>{this._resetMultipleSelectionShortcuts(e)});
                window.removeEventListener('dv-namespace-remove-items', (e)=>{this._removeItems(e)});
                window.removeEventListener('dv-namespace-add-items', (e)=>{this._addItems(e)});
                window.removeEventListener('dv-namespace-request-current-path', (e)=>{this._sendCurrentPath(this.path)});

                window.removeEventListener('dv-namespace-request-item-index', (e)=>{this._sendItemIndex(e)});

                window.removeEventListener('dv-namespace-reset-element-internal-parameters', (e)=>{this._reset(e)});

                this.removeEventListener('click', (e)=>{
                    e.stopPropagation();
                });

                this.$.loading.removeEventListener('contextmenu', (e)=>{this._openContextMenu(e)});
            }
            static get is()
            {
                return "view-file";
            }

            static get properties()
            {
                return {
                    path: {
                        type: String,
                        notify: true
                    },

                    parent: {
                        type: String,
                        notify: true,
                        computed: '_computeParentPath(path)'
                    },

                    selectedItem: {
                        type: Object
                    },

                    url: {
                        type: String,
                        notify: true,
                        computed: '_url(path)'
                    },

                    currentDirName: {
                        type: String,
                        computed: '_computeCurrentDirName(path)',
                        notify: true
                    },

                    name: {
                        type:String,
                        notify: true
                    },

                    target: {
                        type: Object
                    },

                    __counter__: {
                        type: Number,
                        value: 0,
                        notify: true
                    },

                    loading: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    multiSelection: {
                        type: Boolean,
                        notify: true
                    },

                    _isSubsequentRequest: {
                        type: Boolean,
                        value: false
                    },

                    _shiftKeyOn: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    _ctrlKeyOn: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    _xSelectedItems: {
                        type: Array,
                        value: ()=>{return [];},
                        notify: true
                    },

                    _temporarySelectedItemsHolder: {
                        type: Array,
                        value: ()=>{return [];}
                    }
                }
            }

            static get observers()
            {
                return [
                    'changedItems(items.*)',
                    'selectedItemChanged(selectedItem)',
                    '_temporarySelectedItemsHolderModified(_temporarySelectedItemsHolder.splices)',
                    '__xSelectedItemsChanged(_xSelectedItems.splices)',
                    '_sendCurrentPath(path)'
                ];
            }

            _computedUpw(path)
            {
                if (!(sessionStorage.upauth === undefined || sessionStorage.upauth == null)) {
                    return window.atob(sessionStorage.upauth);
                } else {
                    return "anonymous:nopassword";
                }
            }

            _computedDraggable(isSelected)
            {
                return !!isSelected;
            }

            _computedClass(isSelected)
            {
                let classes = 'item';
                if (isSelected) {
                    classes += ' selected';
                }

                this.updateStyles();

                return classes;
            }

            _url(path)
            {
                let x;
                const url  = window.CONFIG["dcache-view.endpoints.webapi"] + "namespace";
                const isHome = path===null || path === "" || path === "/";
                if (sessionStorage.upauth !== undefined) {
                    x = isHome === true ? "/?children=true&qos=true": path + "/?children=true&qos=true";
                } else {
                    x = isHome === true ? "/?children=true": path + "/?children=true";
                }
                return url + x;
            }

            _computeParentPath(path)
            {
                if ( this.path == null || this.path == "" || this.path == "/" ) {
                    path = "/";
                    return path;
                } else {
                    path = decodeURIComponent(this.path);
                    path = path.replace(/=/g, "/");
                    return path + "/";
                }
            }

            handleResponse(e)
            {
                var children = e.detail.response.children;
                var d = this;

                if ( children.length == 0 && this.__counter__ == 0 ) {
                    var content = this.$.content;
                    var el1 = new EmptyDirectory();
                    content.appendChild(el1);
                } else {
                    children.forEach(function (child) {
                        d.$.feList.push('items', child)
                    });
                    this.$.threshold.clearTriggers();
                    this.__counter__++;
                }

                Polymer.dom.flush();
                this.updateStyles();

                e.stopPropagation();
            }

            handleError(request)
            {
                let msg = request.detail.error.message;
                let code = request.detail.request.__data.status;
                let content = this.$.content;

                switch (parseInt(code)) {
                    case 401:
                        const a = '"page":"home","path":"' + this.path + '"';
                        let pathName = '/user-login?r=' + encodeURIComponent(a);
                        page.redirect(pathName);
                        break;
                    case 403:
                        msg = "Access Denied! Please login using a credentials with the right permission.";
                        break;
                    default:
                        code = code===undefined?"500":code;
                        msg = msg ===undefined?
                            "Something is terribly wrong! Please contact your admin.":msg;

                }

                let dle = new DirectoryLsError(msg, code);
                content.appendChild(dle);

                Polymer.dom.flush();
                this.updateStyles();
            }

            changedItems(changedRecord)
            {
                if (changedRecord.path) {
                    this.querySelector('iron-list').fire('iron-resize');
                }
            }

            selectedItemChanged(selectedItem)
            {
                if (selectedItem) {
                    if (this._shiftKeyOn) {
                        this._temporarySelectedItemsHolder.push({"keyValue":"shift","file":selectedItem});
                    } else if (this._ctrlKeyOn) {
                        this._temporarySelectedItemsHolder.push({"keyValue":"ctrl","file":selectedItem});
                    } else {
                        this._temporarySelectedItemsHolder.push({"keyValue":"none","file":selectedItem});
                    }

                    this.notifySplices('_temporarySelectedItemsHolder');
                    this.$.feList.clearSelection();
                }
            }

            openDialog(targetNode, name)
            {
                this.name = name;
                this._previousName = name;
                const dialog = this.$.dialog;
                dialog.positionTarget = targetNode.$.nameContainer;
                this._renameTargetNode = targetNode;
                dialog.open();
            }

            _rename()
            {
                var d = this;
                var namespace = document.createElement('dcache-namespace');
                namespace.auth = app.getAuthValue();
                var path = this.path.endsWith("/") ? this.path : this.path + "/";
                var url = window.CONFIG["dcache-view.endpoints.webapi"] + "namespace";
                var source = path + this._previousName;
                var target = path + this.name;
                namespace.mv({
                    url: url,
                    path: source,
                    destination: target
                });

                var dialog = Polymer.dom(this.root).querySelector('#dialog');
                namespace.promise.then(
                    function () {
                        d._renameTargetNode.$.fileName.innerHTML = d.name;
                        d._renameTargetNode.name = d.name;
                        app.$.toast.text = "Done! File renamed. ";
                        app.$.toast.show();
                        dialog.close();
                    }
                ).catch(
                    function (err) {
                        app.$.toast.text = err.message;
                        app.$.toast.show();
                        dialog.close();
                    }
                );
            }

            _loadNamespaceData()
            {
                //FIXME: race condition problem
                if (this._isSubsequentRequest) {
                    this.__listDirectory();
                } else {
                    window.addEventListener('WebComponentsReady', () => {
                        this.__listDirectory();
                        this._isSubsequentRequest = true;
                    });
                }
            }
            __listDirectory()
            {
                const limit = 100;
                let offset = this.__counter__ * limit;
                let authzValue = app.getAuthValue();

                this.$.ajax.headers = {
                    "Authorization": authzValue,
                    "Accept": "application/json",
                    "Suppress-WWW-Authenticate": "Suppress"
                };
                this.$.ajax.url = this.url;
                this.$.ajax.params = {"limit":limit, "offset": offset};
                this.$.ajax.generateRequest();
            }

            _multipleSelectionShortcuts(event)
            {
                if ((window.navigator.platform.match("Mac")
                        ? event.metaKey : event.ctrlKey) && event.key === "ArrowUp") {
                    this.__arrowUpDown_CtrlShift('up');
                } else if ((window.navigator.platform.match("Mac")
                        ? event.metaKey : event.ctrlKey) && event.key === "ArrowDown") {
                    this.__arrowUpDown_CtrlShift('down');
                } else if (event.shiftKey && event.key === "ArrowUp") {
                    this.__arrowUpDown_CtrlShift('up');
                } else if (event.shiftKey && event.key === "ArrowDown") {
                    this.__arrowUpDown_CtrlShift('down');
                } else if (event.key === "ArrowUp" || event.key === "ArrowDown") {
                    const key = event.key;
                    const file = this._temporarySelectedItemsHolder[this._temporarySelectedItemsHolder.length - 1].file;

                    this.$.feList.clearSelection();
                    this._removeAllXSelected();
                    this._temporarySelectedItemsHolder = [];
                    let index;
                    switch (key) {
                        case 'ArrowUp':
                            index = this.$.feList.items.indexOf(file) - 1 === -1 ? 0 :
                                this.$.feList.items.indexOf(file) - 1;
                            break;
                        default:
                            index = this.$.feList.items.indexOf(file) + 1 === this.$.feList.items.length ?
                                this.$.feList.items.indexOf(file) : this.$.feList.items.indexOf(file) + 1;
                    }
                    this.$.feList.selectIndex(index);
                } else if (event.shiftKey) {
                    this._shiftKeyOn = true;
                    this._ctrlKeyOn = false;
                } else if (window.navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey) {
                    this._shiftKeyOn = false;
                    this._ctrlKeyOn = true;
                }

            }

            _resetMultipleSelectionShortcuts(event)
            {
                if (event.key === "Shift") {
                    this._shiftKeyOn = false;
                }

                if (window.navigator.platform.match("Mac") ?
                        event.key === "Meta" : event.key === "Control") {
                    this._ctrlKeyOn = false;
                }
            }

            __computedXselected(xSelected)
            {
                return xSelected ? xSelected: false;
            }

            _xSelectItem(index)
            {
                this.$.feList.items[index].xSelected = true;
                this.$.feList.notifyPath(`items.${index}.xSelected`);
            }

            _removeAllXSelected()
            {
                const items = this.$.feList.items;
                const len = items.length;
                for (let i=0; i < len; i++) {
                    if (items[i].xSelected) {
                        this._removeXSelected(i);
                    }
                }
            }

            _removeXSelected(idx)
            {
                this.$.feList.items[idx].xSelected = false;
                this.$.feList.notifyPath(`items.${idx}.xSelected`);
                delete this.$.feList.items[idx].xSelected;
            }

            _temporarySelectedItemsHolderModified(arr)
            {
                if (arr) {
                    const len = this._temporarySelectedItemsHolder.length;
                    const lastKeyValue = this._temporarySelectedItemsHolder[len-1].keyValue;
                    const lastFile = this._temporarySelectedItemsHolder[len-1].file;
                    const idx1 = this.$.feList.items.indexOf(lastFile);
                    switch (lastKeyValue) {
                        case 'none':
                            this._removeAllXSelected();
                            lastFile.xSelected = true;
                            this._temporarySelectedItemsHolder = [{"keyValue":"none", "file": lastFile}];
                            this._xSelectItem(idx1);
                            break;
                        case 'shift':
                            let idx0;
                            for (let i = 2; i < len+1; i++ ) {
                                if (this._temporarySelectedItemsHolder[len-i].keyValue !== "shift") {
                                    idx0 =
                                        this.$.feList.items.indexOf(this._temporarySelectedItemsHolder[len-i].file);
                                    break;
                                }
                            }

                            if (len > 2 && (this._temporarySelectedItemsHolder[len-2].keyValue === "shift")) {
                                const idx0S =
                                    this.$.feList.items.indexOf(this._temporarySelectedItemsHolder[len-2].file);
                                const idxes = this.__getLoopBoundaries(idx0S, idx1);
                                for (let i = idxes[0]; i < idxes[1]; i++) {
                                    this._removeXSelected(i);
                                }
                            }

                            if (this.__getLoopBoundaries(idx0, idx1) !== []) {
                                const idxes = this.__getLoopBoundaries(idx0, idx1);

                                for (let i = idxes[0]; i < idxes[1]; i++) {
                                    this._xSelectItem(i)
                                }
                            }
                            break;
                        case 'ctrl':
                            if (this.$.feList.items[idx1].xSelected) {
                                this._removeXSelected(idx1);

                                const id = this._temporarySelectedItemsHolder.findIndex(el => {
                                    return el.file.fileName === lastFile.fileName;
                                });
                                if (id >= 0) {
                                    this._temporarySelectedItemsHolder.splice(id, 1);
                                }
                            } else {
                                this._temporarySelectedItemsHolder[len-1].file.xSelected = true;
                                this._xSelectItem(idx1);
                            }
                            break;
                        case 'arrow-up':
                        case 'arrow-down':
                            if (this.$.feList.items[idx1].xSelected) {
                                const myD = this._temporarySelectedItemsHolder.slice(0,len-1);
                                const id = myD.findIndex(el => {
                                    return el.file.fileName === lastFile.fileName;
                                });
                                if (id >= 0 && myD[id].keyValue === lastKeyValue) {
                                    this._removeXSelected(idx1);
                                    this._temporarySelectedItemsHolder.splice(id, 1);
                                }
                            } else {
                                this._temporarySelectedItemsHolder[len-1].file.xSelected = true;
                                this._xSelectItem(idx1);
                            }
                            break;
                    }
                    this.__getAllItemsXSelected();
                }
            }

            __getLoopBoundaries(idx0,idx1)
            {
                return idx0 < idx1 || idx0 > idx1 ? idx0 < idx1 ? [idx0, idx1 + 1] : [idx1, idx0 + 1] : [];
            }

            __getAllItemsXSelected()
            {
                this._xSelectedItems = [];
                const len = (this.$.feList.items).length;
                for (let i=0; i<len; i++) {
                    if (this.$.feList.items[i].xSelected) {
                        const x = Object.assign({}, this.$.feList.items[i]);
                        delete x.xSelected;
                        this._xSelectedItems.push(x);
                    }
                }
                this.notifySplices('_xSelectedItems');
            }

            __xSelectedItemsChanged(arr)
            {
                if (arr) {
                    this.dispatchEvent(
                        new CustomEvent('dv-namespace-x-selected-items-changed', {
                            detail:{xSelectedItems: this._xSelectedItems},
                            bubbles: true, composed: true})
                    );
                }
            }

            _removeItems(event)
            {
                const files = event.detail.files;
                const len = this.$.feList.items.length;
                files.forEach( (file) => {
                    for (let i=0; i < len; i++) {
                        if (this.$.feList.items[i].fileName === file.fileName) {
                            this.$.feList.splice('items', i, 1);
                            if (this._xSelectedItems.length > 0) {
                                const idx = this._xSelectedItems.indexOf(file);
                                this.splice('_xSelectedItems', idx, 1);
                            }
                            break;
                        }
                    }
                });
            }

            _addItems(event)
            {
                const ed = this.shadowRoot.querySelector('empty-directory');
                if (ed) {
                    this.$.content.removeChild(ed);
                }
                if (this.$.feList !== null || this.$.feList !== undefined) {
                    const files = event.detail.files;
                    files.forEach( (file) => {
                        this.$.feList.unshift('items',file);
                    });
                }
                this.$.feList.fire('iron-resize');
            }

            _sendCurrentPath(pt)
            {
                this.dispatchEvent(
                    new CustomEvent('dv-namespace-current-path', {
                        detail: {currentPath: pt}, bubbles: true, composed: true}));
            }

            /**
             * TODO: Moved the method to the Base mixin class
             */
            __findItemIndexOnAList(list, item, searchKey)
            {
                searchKey = !searchKey ? 'fileName': searchKey;
                return list.findIndex(el => {
                    return el[`${searchKey}`] === item[`${searchKey}`];
                });
            }

            __getItemCurrentIndex(item)
            {
                return this.__findItemIndexOnAList(this.$.feList.items, item);
            }

            _sendItemIndex(event)
            {
                const index = this.__getItemCurrentIndex(event.detail.item.fileName);
                this.dispatchEvent(
                    new CustomEvent('dv-namespace-receive-item-index', {
                        detail: {index: index}, bubbles: true, composed: true}));
            }

            _reset(event)
            {
                if (event.detail.element === "view-file") {
                    this.$.feList.clearSelection();
                    this._removeAllXSelected();
                    this._xSelectedItems = [];
                    this._temporarySelectedItemsHolder = [];
                    this.notifySplices('_xSelectedItems');
                    this._shiftKeyOn = false;
                    this._ctrlKeyOn = false;
                }
            }

            __arrowUpDown_CtrlShift(arrowType)
            {
                const file =
                    this._temporarySelectedItemsHolder[this._temporarySelectedItemsHolder.length - 1].file;
                const keyValue =
                    this._temporarySelectedItemsHolder[this._temporarySelectedItemsHolder.length - 1].keyValue;
                const idx = this.__getItemCurrentIndex(file);

                if (keyValue === 'arrow-down' && arrowType === 'up'
                        || keyValue === 'arrow-up' && arrowType === 'down') {
                    this._removeXSelected(idx);
                    this._temporarySelectedItemsHolder.pop();
                    this.__getAllItemsXSelected();
                    return;
                }
                switch (arrowType) {
                    case 'up':
                        if (idx > 0) {
                            const selectedItem = this.$.feList.items[idx-1];
                            this._temporarySelectedItemsHolder.push({"keyValue": "arrow-up", "file": selectedItem});
                            this.notifySplices('_temporarySelectedItemsHolder');
                        }
                        break;
                    case 'down':
                        if (idx >= 0 && idx < this.$.feList.items.length -1) {
                            const selectedItem = this.$.feList.items[idx + 1];
                            this._temporarySelectedItemsHolder.push({"keyValue": "arrow-down", "file": selectedItem});
                            this.notifySplices('_temporarySelectedItemsHolder');
                        }
                        break;
                }
            }

            _openContextMenu(event)
            {
                event.preventDefault();
                event.stopPropagation();
                /**
                 * A WORKAROUND for firefox
                 * TODO: When firefox support web components fully, revisit.
                 */
                this.dispatchEvent(new MouseEvent('contextmenu', {
                    view: window,
                    bubbles: true,
                    composed: true,
                    cancelable: true,
                    clientX: event.clientX,
                    clientY: event.clientY,
                    screenX: event.screenX,
                    screenY: event.screenY
                }));
            }

            _computeCurrentDirName(path)
            {
                return path === "/" ? 'ROOT' : path.slice(path.lastIndexOf("/")+1);
            }
        }
        window.customElements.define(ViewFile.is, ViewFile);
    </script>
</dom-module>