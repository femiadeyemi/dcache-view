<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-item/paper-icon-item.html">

<link rel="import" href="../qbi-dialog-content/qbi-dialog-content.html">
<link rel="import" href="change-qos-context-menu.html">
<dom-module id="namespace-contextual-content">
    <template>
        <style>
            :host paper-listbox {
                margin-top: -20px;
                margin-bottom: -20px;
            }
            paper-icon-item:hover{
                background: #0e5aff;
                color: #fff !important;
            }
            paper-icon-item {
                font-size: 0.8em;
                min-height: 40px !important;
                font-weight: normal !important;
            }
            .none {
                display: none;
            }
            #open {
                border-bottom: 1px solid #cacaca;
            }
            #delete, #download {
                border-top: 1px solid #cacaca;
            }
        </style>
        <paper-listbox>
            <paper-icon-item  id="open"
                              class$="[[_computedClass('open', singleSelection,
                              multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="visibility" slot="item-icon"></iron-icon>
                Open
            </paper-icon-item>

            <paper-icon-item id="changeQos"
                             class$="[[_computedClass('changeQos' , singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="settings-input-composite" slot="item-icon"></iron-icon>
                Change QoS to ...
            </paper-icon-item>
            <paper-icon-item id="qosInfo"
                             class$="[[_computedClass('qosInfo', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="settings-remote" slot="item-icon"></iron-icon>
                Get QoS backend info
            </paper-icon-item>
            <paper-icon-item id="move"
                             class$="[[_computedClass('move', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="move-icons:movefolder" slot="item-icon"></iron-icon>
                Move to ...
            </paper-icon-item>
            <paper-icon-item id="rename"
                             class$="[[_computedClass('rename', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="editor:border-color" slot="item-icon"></iron-icon>
                Rename
            </paper-icon-item>

            <paper-icon-item id="download"
                             class$="[[_computedClass('download', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="cloud-download" slot="item-icon"></iron-icon>
                Download
            </paper-icon-item>

            <paper-icon-item id="create"
                             class$="[[_computedClass('create', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="create-new-folder" slot="item-icon"></iron-icon>
                Create new folder
            </paper-icon-item>
            <paper-icon-item id="upload"
                             class$="[[_computedClass('upload', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="cloud-upload" slot="item-icon"></iron-icon>
                Upload file(s)
            </paper-icon-item>

            <paper-icon-item id="metadata"
                             class$="[[_computedClass('metadata', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="info" slot="item-icon"></iron-icon>
                View details
            </paper-icon-item>

            <paper-icon-item id="delete"
                             class$="[[_computedClass('delete', singleSelection,
                             multipleSelection, currentDir, targetNode)]]">
                <iron-icon icon="delete" slot="item-icon"></iron-icon>
                Delete
            </paper-icon-item>
        </paper-listbox>
    </template>
    <script>
        class NamespaceContextualContent extends Polymer.Element
        {
            constructor(t,n)
            {
                super();
                this.singleSelection = n === 0;
                this.multipleSelection = n === 1;
                this.currentDir = n === 2;
                this.targetNode = t;
                this._cqcm = new ChangeQosContextualMenu(t);
            }

            static get is()
            {
                return 'namespace-contextual-content';
            }

            static get properties()
            {
                return {
                    currentDir: {
                        type: Boolean,
                        notify: true
                    },
                    multipleSelection: {
                        type: Boolean,
                        notify: true
                    },
                    singleSelection: {
                        type: Boolean,
                        notify: true
                    },
                    targetNode: {
                        type: Object
                    },
                    currentPath: {
                        type: String,
                    }
                }
            }

            ready()
            {
                super.ready();
                if (app.$.centralSubContextMenu.opened) {
                    app.$.centralSubContextMenu.close();
                }
                app.$.centralSubContextMenu.innerHTML = "";
            }

            connectedCallback()
            {
                super.connectedCallback();
                if (this.singleSelection) {
                    this.$.delete.addEventListener('tap', this._delete.bind(this));
                    this.$.metadata.addEventListener('tap', this._metadata.bind(this));
                    this.$.move.addEventListener('tap', this._move.bind(this));
                    this.$.qosInfo.addEventListener('tap', this._qosInfo.bind(this));
                    this.$.rename.addEventListener('tap', this._rename.bind(this));

                    switch (this.targetNode.fileType) {
                        case "DIR":
                            this.$.open.addEventListener('tap', this._open.bind(this));
                            break;
                        case "REGULAR":
                            this.$.download.addEventListener('tap', this._download.bind(this));
                            break;
                    }

                } else if (this.multipleSelection) {
                    this.$.delete.addEventListener('tap', this._delete.bind(this));
                    this.$.move.addEventListener('tap', this._move.bind(this));
                } else if (this.currentDir) {
                    this.$.create.addEventListener('tap', this._create.bind(this));
                    this.$.metadata.addEventListener('tap', this._metadata.bind(this));
                    this.$.qosInfo.addEventListener('tap', this._qosInfo.bind(this));
                    this.$.upload.addEventListener('tap', this._upload.bind(this));
                }

                this.addEventListener('mouseover', this._mouseOverLeave);
                this.$.changeQos.addEventListener('mouseover', this._mouseOver.bind(this));

                window.addEventListener('dv-namespace-current-path',(e)=>{this._setCurrentPath(e)});
                this.dispatchEvent(
                    new CustomEvent('dv-namespace-request-current-path', {bubbles: true, composed: true}));
            }

            disconnectedCallback()
            {
                super.disconnectedCallback();
                if (this.singleSelection) {
                    this.$.delete.removeEventListener('tap', this._delete);
                    this.$.metadata.removeEventListener('tap', this._metadata);
                    this.$.move.removeEventListener('tap', this._move);
                    this.$.qosInfo.removeEventListener('tap', this._qosInfo);
                    this.$.rename.removeEventListener('tap', this._rename);

                    switch (this.targetNode.fileType) {
                        case "DIR":
                            this.$.open.removeEventListener('tap', this._open);
                            break;
                        case "REGULAR":
                            this.$.download.removeEventListener('tap', this._download);
                            break;
                    }

                } else if (this.multipleSelection) {
                    this.$.delete.removeEventListener('tap', this._delete);
                    this.$.move.removeEventListener('tap', this._move);
                } else if (this.currentDir) {
                    this.$.create.removeEventListener('tap', this._create);
                    this.$.metadata.removeEventListener('tap', this._metadata);
                    this.$.qosInfo.removeEventListener('tap', this._qosInfo);
                    this.$.upload.removeEventListener('tap', this._upload);
                }

                this.removeEventListener('mouseover', this._mouseOverLeave);
                this.$.changeQos.removeEventListener('mouseover', this._mouseOver);

                window.removeEventListener('dv-namespace-current-path',(e)=>{this._setCurrentPath(e)});
            }

            _mouseOverLeave()
            {
                if (app.$.centralSubContextMenu.opened) {
                    app.$.centralSubContextMenu.close();
                }
            }

            _mouseOver(e)
            {
                e.stopPropagation();
                if (!window.CONFIG.isSomebody) {
                    app.$.toast.text = "You need to login to be able to perform this operation. ";
                    app.$.toast.show();
                    return;
                }
                if (!app.$.centralSubContextMenu.opened) {
                    app.$.centralSubContextMenu.appendChild(this._cqcm);
                    let x = 0, y = 0;

                    if (e.pageX || e.pageY) {
                        x = e.pageX;
                        y = e.pageY;
                    } else if (e.clientX || e.clientY) {
                        x = e.clientX + document.body.scrollLeft +
                            document.documentElement.scrollLeft;
                        y = e.clientY + document.body.scrollTop +
                            document.documentElement.scrollTop;
                    }

                    const vx = window.innerWidth;
                    const vy = window.innerHeight;
                    const w = 250;
                    const h = 100;

                    if (vx - app.x < w*2.1) {
                        app.a = app.x - w;
                    } else {
                        app.a = w + app.x;

                    }
                    app.b = app.y + 15;
                    app.notifyPath('a');
                    app.notifyPath('b');
                    app.$.centralSubContextMenu.resetFit();
                    app.$.centralSubContextMenu.open();
                }

                e.stopPropagation();
            }

            _open()
            {
                app.$.centralContextMenu.close();
                app.ls(this.targetNode.filePath);
                Polymer.dom.flush();
            }

            _download()
            {
                app.$.centralContextMenu.close();
                let path;
                const webdav = window.CONFIG["dcache-view.endpoints.webdav"];
                if (webdav === "") {
                    path =
                        window.location.protocol + "//" + window.location.hostname
                        + ":2880" + this.targetNode.filePath;
                } else {
                    if (webdav.endsWith("/")) {
                        path = webdav.substring(0, webdav.length-1) + this.targetNode.filePath;
                    } else {
                        path = webdav + this.targetNode.filePath;
                    }
                }
                window.open(path);
            }

            _metadata()
            {
                app.$.centralContextMenu.close();
                if (app.$.metadataDrawer.querySelector('file-metadata')) {
                    app.$.metadataDrawer.removeChild(
                        app.$.metadataDrawer.querySelector('file-metadata'));
                }
                const fm = this.targetNode.fileMData ?
                    new FileMetadata(this.targetNode.fileMData, this.targetNode.filePath, 0) :
                    new FileMetadata(this.targetNode, this.targetNode.filePath, 1);
                app.$.metadataDrawer.appendChild(fm);
                app.$.metadata.openDrawer();
            }

            _rename()
            {
                app.$.centralContextMenu.close();
                const vf = document.querySelector('view-file');
                vf.openDialog(this.targetNode, this.targetNode.name);
            }

            _move()
            {
                app.$.centralContextMenu.close();
                let noOfMovedItems = 1;
                let fileType = "item";
                const dialogBox = document.getElementById('centralDialogBox');
                app.removeAllChildren(dialogBox);
                const mv = document.createElement('move-file');
                mv.auth = app.getAuthValue();
                mv.currentPath = this.currentPath;

                if (this.multipleSelection) {
                    mv.mvFiles = this.targetNode.files;
                    noOfMovedItems = mv.mvFiles.length;
                    fileType = "items";
                } else {
                    mv.mvFiles = [this.targetNode.fileMData];
                }

                mv.addEventListener('move', (e) => {
                    this.dispatchEvent(new CustomEvent('dv-namespace-remove-items', {
                        detail: {files: mv.mvFiles},bubbles: true, composed: true}));
                    dialogBox.close();
                    app.$.toast.text = `${noOfMovedItems} ${fileType} have been moved from
                        ${e.detail.response.sourceDirName} to ${e.detail.response.targetDirName}. `;
                    app.$.toast.show();
                });
                mv.addEventListener('error', function (e) {
                    app.$.toast.text = e.detail.error+ " ";
                    app.$.toast.show();
                });
                mv.addEventListener('dismiss', function (e) {
                    dialogBox.close();
                });
                mv.addEventListener('move-create', function (e) {
                    const file = {
                        "fileName" : e.detail.name,
                        "fileMimeType" : "application/vnd.dcache.folder",
                        "fileLocality" : "",
                        "size" : "--",
                        "fileType" : "DIR",
                        "mtime" : "--",
                        "creationTime" : Date.now() //Assumption
                    };
                    this.dispatchEvent(new CustomEvent('dv-namespace-add-items', {
                        detail: {files: [file]},bubbles: true, composed: true}));
                });
                dialogBox.appendChild(mv);
                dialogBox.open();
            }

            _delete()
            {
                app.$.centralContextMenu.close();
                if (sessionStorage.upauth === null || sessionStorage.upauth === undefined) {
                    app.$.toast.text = 'You need to login to delete file(s). ';
                    app.$.toast.show();
                    return;
                }
                let url = window.CONFIG["dcache-view.endpoints.webapi"] + "namespace";

                if (this.multipleSelection) {
                    let vf = document.getElementById('homedir').querySelector('view-file');
                    vf.multiSelection = false;

                    for (let i=0; i<this.targetNode.files.length; i++) {
                        this._deleteSingleEntry(url, this.targetNode.files[i].fileName,
                            this.targetNode.parentPath + this.targetNode.files[i].fileName);
                    }

                    vf.multiSelection = true;
                } else {
                    if (this.targetNode.checkboxDisplay) {
                        this.targetNode.querySelector('paper-checkbox').checked = false;
                    }
                    this._deleteSingleEntry(url, this.targetNode.name, this.targetNode.filePath);
                }
            }

            _deleteSingleEntry(url, name, path)
            {
                let namespace = document.createElement('dcache-namespace');
                namespace.auth = app.getAuthValue();
                namespace.promise.then(
                    ()=>{
                        let list = app.$.homedir.querySelector('view-file').$.feList;
                        let arr = list.items;
                        const len = arr.length;
                        for (let i=0; i<len; i++) {
                            if (arr[i].fileName == name) {
                                list.splice('items', i, 1);
                                break;
                            }
                        }

                        if (len === 1) {
                            const ed = document.createElement('empty-directory');
                            const vf = document.querySelector('view-file');
                            vf.querySelector('#content').appendChild(ed);
                        }

                        const type = this.targetNode.fileType == "DIR" ? "Folder" : "File";
                        app.$.toast.text = type + " deleted. ";
                        app.$.toast.show();
                    }
                ).catch(
                    function(err) {
                        app.$.toast.text = err.message;
                        app.$.toast.show();
                    }
                );
                namespace.rm({
                    url: url,
                    path: path
                });
            }

            _create()
            {
                app.$.centralContextMenu.close();

                const dialogBox = document.getElementById('centralDialogBox');
                app.removeAllChildren(dialogBox);

                let mkdir = document.createElement('create-directory');
                mkdir.dirFullPath = this.currentPath;
                mkdir.header = false;
                mkdir.addEventListener('create',(e) => {
                    let name = e.detail.newFolderName;
                    let url = window.CONFIG["dcache-view.endpoints.webapi"] + "namespace";
                    let namespace = document.createElement('dcache-namespace');
                    namespace.auth = app.getAuthValue();

                    namespace.promise.then(() => {
                        dialogBox.close();
                        dialogBox.removeChild(mkdir);
                        const file = {
                            "fileName" : name,
                            "fileMimeType" : "application/vnd.dcache.folder",
                            "fileLocality" : "",
                            "size" : "--",
                            "fileType" : "DIR",
                            "mtime" : "--",
                            "creationTime" : Date.now() //Assumption
                            //TODO: add creation time to the return object of the ajax response
                        };
                        this.dispatchEvent(new CustomEvent('dv-namespace-add-items', {
                            detail: {files: [file]}, bubbles: true, composed: true})
                        );
                        app.$.toast.text = "Done! New directory created. ";
                        app.$.toast.show();
                    }).catch(
                        function(err) {
                            app.$.toast.text = err.message + " ";
                            app.$.toast.show();
                        }
                    );

                    namespace.mkdir({
                        url: url,
                        path: this.currentPath,
                        name: name
                    });
                });
                mkdir.addEventListener('close',function() {
                    dialogBox.close();
                    dialogBox.removeChild(mkdir);
                });
                dialogBox.appendChild(mkdir);
                dialogBox.open();
            }

            _upload()
            {
                app.$.centralContextMenu.close();

                let uploadButton = document.createElement('upload-files-button');
                uploadButton.querySelector('#files').click();
            }

            _qosInfo()
            {
                app.$.centralContextMenu.close();

                let dialogBox = document.getElementById('centralDialogBox');
                dialogBox.innerHTML = "";

                if (!window.CONFIG.isSomebody) {
                    app.$.toast.text = "You need to login to view this information. ";
                    app.$.toast.show();
                    return;
                }
                if (window.CONFIG.qos === undefined) {
                    app.$.toast.text = "Request have been sent, please check again in a minute or two. ";
                    app.$.toast.show();
                    return;
                }

                let content = document.createElement('qbi-dialog-content');

                dialogBox.appendChild(content);
                dialogBox.open();
            }

            /**
             * NOTE: @id value in this function must be exactly
             * the same as the element/node id attribute.
             */
            _computedClass(id, singleSelection, multipleSelection, currentDir, t)
            {
                if (currentDir && (id === 'open' || id === 'move' || id === 'rename' || id === 'download'
                    || id === 'delete' || id === 'changeQos' || id === 'qosInfo')) {
                    return ' none';
                } else {
                    if (!currentDir && (id === 'upload' || id === 'create')) {
                        return ' none';
                    }

                    this._setDisabledAttribute(id, singleSelection, multipleSelection, t);
                    this.updateStyles();
                    return '';
                }
            }

            _setDisabledAttribute(id, singleSelection, multipleSelection, t)
            {
                if (multipleSelection && (id === 'open' || id === 'metadata' || id === 'rename' ||
                    id === 'download' || id === 'changeQos' || id === 'qosInfo')) {
                    this.root.querySelector('#'+id).setAttribute('disabled', "");
                }

                if (singleSelection) {
                    if (t.fileType === 'DIR' && (id === 'download' || id === 'changeQos')) {
                        this.root.querySelector('#'+id).setAttribute('disabled', "");
                    } else if (id  === 'open' && t.fileType === 'REGULAR') {
                        this.root.querySelector('#'+id).setAttribute('disabled', "");
                    }
                }
            }

            _setCurrentPath(e)
            {
                this.currentPath = e.detail.currentPath;
            }
        }
        window.customElements.define(NamespaceContextualContent.is, NamespaceContextualContent);
    </script>
</dom-module>