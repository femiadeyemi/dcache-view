<script src="../bower_components/page/page.js"></script>
<script>
    window.addEventListener('WebComponentsReady', function() {

        /**
         * We use Page.js for routing. This is a Micro client-side router.
         *  More info: https://visionmedia.github.io/page.js/
         *
         * WARNING: This application fully relying on this page,
         * editing it will modified this application behaviour.
         */

        // Removes end / from app.baseUrl which page.base requires for production
        if (window.location.port === '') {  // if production
            page.base(app.baseUrl.replace(/\/$/, ''));
        }

        // Middleware
        window.CONFIG.isSomebody = sessionStorage.upauth !== undefined;
        app.config = window.CONFIG;
        app.organisationName = window.CONFIG["dcache-view.org-name"];


        // Routes
        page('*', function(ctx, next) {
            next();
        });

        page('/', function() {
            app.route = 'home';
            app.params = "";
        });

        page(app.baseUrl, function() {
            app.route = 'home';
            app.params = "";
        });

        page('/admin', function() {
            app.route = 'admin';
            app.params = "";
        });

        page('/admin/:component', function(data) {
            app.route = 'admin-component-page';
            app.params = data.params;
        });

        page('/user-login', function(ctx) {
            let loginSection = app.$.loginSection;
            loginSection.innerHTML = "";
            let a = JSON.parse('{'+ ctx.querystring.substr(2) + '}');
            let ulp = new UserLoginPage(a);
            loginSection.appendChild(ulp);
            app.route = 'user-login';
            app.params = "";
        });

        page('/user-profile', function() {
            if (!window.CONFIG.isSomebody) {
                const a = '"page":"user-profile","path":""';
                let pathName = '/user-login?r=' + encodeURIComponent(a);
                page.redirect(pathName);
                return;
            }

            let up = new UserProfile();
            app.$.userProfileContainer.innerHTML = "";
            app.$.userProfileContainer.appendChild(up);
            app.route = 'user-profile';
            app.params = "";
        });

        // 404
        page('*', function() {
            let href = window.location.href;
            if (href.includes("state") && href.includes("access_token") && href.includes("id_token")
                && href.includes("token_type")) {

                let arr = href.split("/#!/#");
                let v = arr[1].split('&');
                const len = v.length;
                let oidcProviderResponse = {};

                for (let i=0; i<len; i++) {
                    let a = v[i].split('=');
                    oidcProviderResponse[a[0].trim()] = a[1].trim();
                }

                let redirectInfoObj = JSON.parse(sessionStorage.getItem('redirect'));
                let userAuth = new UserAuthentication(redirectInfoObj, oidcProviderResponse.access_token);

                userAuth.addEventListener('error', (e) => {
                    const a = '"page":'+ redirectInfoObj.page + ',"path":"' + redirectInfoObj.path + '"';
                    let pathName = '/user-login?r=' + encodeURIComponent(a);
                    page(pathName);
                    app.$.toast.text = e.detail.message + " ";
                    app.$.toast.show();
                });

                userAuth.send("Bearer");
                sessionStorage.removeItem('redirect');
                return;
            }

            app.$.toast.text = 'Can\'t find: ' + href  + '. Redirected you to Home Page';
            app.$.toast.show();
            page.redirect(app.baseUrl);
        });

        // add #! before urls
        page({
            hashbang: true
        });

        page({
            decodeURLComponents: true
        });
    });
</script>